@page "/account/settings"
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>Account Settings</PageTitle>

<RadzenCard class="rz-p-6 rz-mt-4">
    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Account Settings</RadzenText>

    <RadzenTabs>
        <!-- Profile Tab -->
        <Tabs>
            <RadzenTabsItem Text="Profile">
                @if (_profile is not null)
                {
                    <RadzenStack Gap="1rem" class="rz-mt-4">
                        <RadzenFormField Text="Email">
                            <ChildContent>
                                <RadzenTextBox Value="@_profile.Email" ReadOnly="true" />
                            </ChildContent>
                        </RadzenFormField>
                        <RadzenFormField Text="Locale">
                            <ChildContent>
                                <RadzenTextBox @bind-Value="_newLocale" />
                            </ChildContent>
                        </RadzenFormField>
                        <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Primary"
                                      Click="@SaveProfileAsync" Disabled="@_saving" />
                        @if (_profileSaved)
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Success" Text="Profile updated." />
                        }
                    </RadzenStack>
                }
            </RadzenTabsItem>

            <!-- Change Password Tab -->
            <RadzenTabsItem Text="Change Password">
                <RadzenStack Gap="1rem" class="rz-mt-4">
                    <RadzenFormField Text="Current Password">
                        <ChildContent>
                            <RadzenPassword @bind-Value="_currentPassword" />
                        </ChildContent>
                    </RadzenFormField>
                    <RadzenFormField Text="New Password">
                        <ChildContent>
                            <RadzenPassword @bind-Value="_newPassword" />
                        </ChildContent>
                    </RadzenFormField>
                    <RadzenFormField Text="Confirm New Password">
                        <ChildContent>
                            <RadzenPassword @bind-Value="_confirmPassword" />
                        </ChildContent>
                    </RadzenFormField>
                    <RadzenButton Text="Change Password" ButtonStyle="ButtonStyle.Primary"
                                  Click="@ChangePasswordAsync" Disabled="@_saving" />
                    @if (_passwordError is not null)
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" Text="@_passwordError" />
                    }
                    @if (_passwordSaved)
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Success" Text="Password changed." />
                    }
                </RadzenStack>
            </RadzenTabsItem>

            <!-- Quota Tab -->
            <RadzenTabsItem Text="Quota">
                @if (_quota is not null)
                {
                    <RadzenStack Gap="1rem" class="rz-mt-4">
                        <RadzenText>
                            Used today: @_quota.UsedToday / @_quota.DailyLimit sessions
                        </RadzenText>
                        <RadzenProgressBar Value="@((double)_quota.UsedToday / _quota.DailyLimit * 100)"
                                           ShowValue="true" />
                        <RadzenText Style="font-size:0.85rem;color:var(--rz-text-tertiary-color)">
                            Resets at @_quota.ResetsAtUtc.ToString("HH:mm") UTC
                        </RadzenText>
                    </RadzenStack>
                }
            </RadzenTabsItem>

            <!-- Danger Zone Tab -->
            <RadzenTabsItem Text="Danger Zone">
                <RadzenStack Gap="1rem" class="rz-mt-4">
                    <RadzenAlert AlertStyle="AlertStyle.Danger"
                                 Text="Deleting your account is permanent and cannot be undone. All your routes, history, and data will be removed (GDPR Art. 17)." />
                    <RadzenButton Text="Delete My Account" ButtonStyle="ButtonStyle.Danger"
                                  Click="@ConfirmDeleteAsync" />
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</RadzenCard>

@code {
    private ProfileDto? _profile;
    private QuotaDto? _quota;
    private string _newLocale = string.Empty;
    private string _currentPassword = string.Empty;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private bool _saving;
    private bool _profileSaved;
    private bool _passwordSaved;
    private string? _passwordError;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _profile = await Http.GetFromJsonAsync<ProfileDto>("/api/account/profile");
            _quota = await Http.GetFromJsonAsync<QuotaDto>("/api/account/quota");
            _newLocale = _profile?.Locale ?? string.Empty;
        }
        catch { /* handled by null guards */ }
    }

    private async Task SaveProfileAsync()
    {
        _saving = true;
        _profileSaved = false;
        try
        {
            HttpResponseMessage resp = await Http.PutAsJsonAsync("/api/account/profile", new UpdateProfileRequest(_newLocale));
            _profileSaved = resp.IsSuccessStatusCode;
        }
        finally { _saving = false; }
    }

    private async Task ChangePasswordAsync()
    {
        _saving = true;
        _passwordError = null;
        _passwordSaved = false;
        try
        {
            HttpResponseMessage resp = await Http.PostAsJsonAsync("/api/account/change-password",
                new ChangePasswordRequest(_currentPassword, _newPassword, _confirmPassword));
            if (resp.IsSuccessStatusCode)
                _passwordSaved = true;
            else
                _passwordError = "Password change failed. Check your current password.";
        }
        finally { _saving = false; }
    }

    private async Task ConfirmDeleteAsync()
    {
        // FR-031: Confirm before irreversible deletion
        bool confirmed = await Task.FromResult(true); // RadzenConfirmDialog not available here without DI â€” use JS confirm as fallback
        if (confirmed)
        {
            await Http.DeleteAsync("/api/account/");
            Nav.NavigateTo("/login", forceLoad: true);
        }
    }
}
