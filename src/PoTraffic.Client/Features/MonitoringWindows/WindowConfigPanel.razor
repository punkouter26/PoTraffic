@using System.Net.Http.Json
@using PoTraffic.Shared.DTOs.Routes
@using PoTraffic.Shared.DTOs.History
@using PoTraffic.Shared.Enums
@inject HttpClient Http

<RadzenFieldset Text="Monitoring Window" class="rz-mb-3">
    @if (_loadingWindows)
    {
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" class="rz-mb-2" />
    }
    else if (_activeWindow is not null)
    {
        @* Read-only view — window is immutable once created; delete to replace *@
        <RadzenText TextStyle="TextStyle.Caption" class="rz-mb-1">Days of week:</RadzenText>
        <RadzenText class="rz-mb-3">@string.Join(", ", _activeWindow.DaysOfWeek)</RadzenText>

        <div class="rz-display-flex rz-gap-4 rz-mb-3">
            <div>
                <RadzenText TextStyle="TextStyle.Caption">Start Time</RadzenText>
                <RadzenText>@_activeWindow.StartTime</RadzenText>
            </div>
            <div>
                <RadzenText TextStyle="TextStyle.Caption">End Time</RadzenText>
                <RadzenText>@_activeWindow.EndTime</RadzenText>
            </div>
        </div>

        @* Session status banner *@
        @if (_activeSession is not null)
        {
            <RadzenAlert AlertStyle="AlertStyle.Success" ShowIcon="true" class="rz-mb-2">
                Monitoring active — @_activeSession.PollCount poll(s) recorded today.
                @if (_activeSession.LastPollAt.HasValue)
                {
                    <span> Last poll: @_activeSession.LastPollAt.Value.ToLocalTime().ToString("HH:mm:ss")</span>
                }
            </RadzenAlert>
        }
        else
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-2">
                Monitoring is not active yet. It starts automatically when you open this page and a window is active.
            </RadzenAlert>
        }

        @if (!string.IsNullOrEmpty(_error))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" class="rz-mb-2">@_error</RadzenAlert>
        }

        <div class="rz-display-flex rz-gap-2">
            @if (_activeSession is not null)
            {
                <RadzenButton Text="Stop Monitoring" ButtonStyle="ButtonStyle.Warning" Icon="stop"
                              Click="@StopMonitoringAsync" IsBusy="_saving" />
            }
        </div>
    }
    else
    {
        @* Create form — only shown when no active window exists *@
        <RadzenText TextStyle="TextStyle.Caption" class="rz-mb-2">Days of week:</RadzenText>
        <div class="rz-mb-3">
            @foreach ((string name, byte bit) in _days)
            {
                <label class="rz-mr-3">
                    <input type="checkbox" checked="@_selectedDays[name]"
                           @onchange="@(e => _selectedDays[name] = (bool)(e.Value ?? false))" />
                    @name
                </label>
            }
        </div>

        <div class="rz-display-flex rz-gap-4 rz-mb-3">
            <RadzenFormField Text="Start Time">
                <RadzenDatePicker @bind-Value="_startTime" ShowTime="true" DateFormat="HH:mm" />
            </RadzenFormField>
            <RadzenFormField Text="End Time">
                <RadzenDatePicker @bind-Value="_endTime" ShowTime="true" DateFormat="HH:mm" />
            </RadzenFormField>
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" class="rz-mb-2">@_error</RadzenAlert>
        }

        <RadzenButton Text="Save Window" ButtonStyle="ButtonStyle.Primary"
                      Click="@SaveWindowAsync" IsBusy="_saving" />
    }
</RadzenFieldset>

@code {
    [Parameter] public Guid RouteId { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private bool _loadingWindows = true;
    private bool _saving;
    private MonitoringWindowDto? _activeWindow;
    private SessionDto? _activeSession;
    private string _error = "";

    private DateTime? _startTime = DateTime.Today.AddHours(7);
    private DateTime? _endTime = DateTime.Today.AddHours(9);

    private readonly (string name, byte bit)[] _days =
    [
        ("Mon", 0x01), ("Tue", 0x02), ("Wed", 0x04),
        ("Thu", 0x08), ("Fri", 0x10), ("Sat", 0x20), ("Sun", 0x40)
    ];

    private readonly Dictionary<string, bool> _selectedDays = new()
    {
        ["Mon"] = true, ["Tue"] = true, ["Wed"] = true,
        ["Thu"] = true, ["Fri"] = true, ["Sat"] = false, ["Sun"] = false
    };

    protected override async Task OnParametersSetAsync()
    {
        await LoadWindowAsync();

        if (_activeWindow is not null && _activeSession is null)
        {
            await StartMonitoringAsync();
        }
    }

    private async Task LoadWindowAsync()
    {
        _loadingWindows = true;
        _error = "";
        try
        {
            // Load window configuration
            var windows = await Http.GetFromJsonAsync<List<MonitoringWindowDto>>(
                $"/api/routes/{RouteId}/windows");
            _activeWindow = windows?.FirstOrDefault(w => w.IsActive);

            // Load today's active session (if any)
            _activeSession = null;
            if (_activeWindow is not null)
            {
                var sessions = await Http.GetFromJsonAsync<List<SessionDto>>(
                    $"/api/routes/{RouteId}/sessions");
                DateOnly today = DateOnly.FromDateTime(DateTime.Today);
                _activeSession = sessions?.FirstOrDefault(
                    s => s.State == SessionState.Active && s.SessionDate == today);
            }
        }
        catch { /* silently handled */ }
        finally { _loadingWindows = false; }
    }

    private async Task StartMonitoringAsync()
    {
        if (_activeWindow is null) return;
        _saving = true;
        _error = "";
        try
        {
            HttpResponseMessage resp = await Http.PostAsync(
                $"/api/routes/{RouteId}/windows/{_activeWindow.Id}/start", null);

            if (resp.IsSuccessStatusCode)
            {
                await LoadWindowAsync();
                await OnSaved.InvokeAsync();
            }
            else if (resp.StatusCode == System.Net.HttpStatusCode.TooManyRequests)
                _error = "Daily monitoring quota exceeded. Try again tomorrow.";
            else
                _error = "Failed to start monitoring. Please try again.";
        }
        catch { _error = "Unable to connect. Please try again."; }
        finally { _saving = false; }
    }

    private async Task StopMonitoringAsync()
    {
        if (_activeWindow is null || _activeSession is null) return;
        _saving = true;
        _error = "";
        try
        {
            HttpResponseMessage resp = await Http.PostAsJsonAsync(
                $"/api/routes/{RouteId}/windows/{_activeWindow.Id}/stop",
                new { sessionId = _activeSession.Id });

            if (resp.IsSuccessStatusCode)
            {
                await LoadWindowAsync();
                await OnSaved.InvokeAsync();
            }
            else
                _error = "Failed to stop monitoring. Please try again.";
        }
        catch { _error = "Unable to connect. Please try again."; }
        finally { _saving = false; }
    }

    private async Task SaveWindowAsync()
    {
        _error = "";

        byte mask = 0;
        foreach ((string name, byte bit) in _days)
            if (_selectedDays[name]) mask |= bit;

        if (mask == 0) { _error = "Select at least one day."; return; }
        if (_endTime <= _startTime) { _error = "End time must be after start time."; return; }

        _saving = true;
        try
        {
            HttpResponseMessage resp = await Http.PostAsJsonAsync(
                $"/api/routes/{RouteId}/windows",
                new
                {
                    startTime = _startTime!.Value.ToString("HH:mm:ss"),
                    endTime = _endTime!.Value.ToString("HH:mm:ss"),
                    daysOfWeekMask = mask
                });

            if (resp.IsSuccessStatusCode)
            {
                await LoadWindowAsync();
                await OnSaved.InvokeAsync();
            }
            else
                _error = "Failed to save window. Please try again.";
        }
        catch { _error = "Unable to connect. Please try again."; }
        finally { _saving = false; }
    }

}
