@page "/admin"
@attribute [Authorize(Roles = "Administrator")]
@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>Admin — User Usage</PageTitle>

<RadzenCard class="rz-p-6 rz-mt-4">
    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-2">Admin Tools</RadzenText>
    <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-4">
        Secondary diagnostics and test functionality for administrators.
    </RadzenText>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap" class="rz-mb-4">
        <RadzenButton Text="Usage Insights" ButtonStyle="ButtonStyle.Light" Icon="people"
                      Click="@(() => Nav.NavigateTo("/admin"))" />
        <RadzenButton Text="Global Volatility" ButtonStyle="ButtonStyle.Light" Icon="analytics"
                      Click="@(() => Nav.NavigateTo("/admin/volatility"))" />
        <RadzenButton Text="Diagnostics" ButtonStyle="ButtonStyle.Light" Icon="build"
                      Click="@(() => Nav.NavigateTo("/diag"))" />
        <RadzenButton Text="Triple Test" ButtonStyle="ButtonStyle.Light" Icon="science"
                      Click="@(() => Nav.NavigateTo("/admin/triple-test"))" />
        <RadzenButton Text="System Seed" ButtonStyle="ButtonStyle.Light" Icon="database"
                      Click="@(() => Nav.NavigateTo("/admin/seed"))" />
    </RadzenStack>

    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Daily Usage</RadzenText>

    <LoadingErrorCard IsLoading="_loading" Error="@_error">
        <RadzenDataGrid Data="_users" TItem="UserDailyUsageDto" AllowSorting="true" AllowFiltering="true"
                        PageSize="25" AllowPaging="true" class="rz-mt-2">
            <Columns>
                <RadzenDataGridColumn TItem="UserDailyUsageDto" Property="Email" Title="Email" />
                <RadzenDataGridColumn TItem="UserDailyUsageDto" Property="Locale" Title="Locale" Width="80px" />
                <RadzenDataGridColumn TItem="UserDailyUsageDto" Property="TodayPollCount" Title="Polls Today" Width="110px" />
                <RadzenDataGridColumn TItem="UserDailyUsageDto" Property="TodayEstimatedCostUsd" Title="Est. Cost (USD)" Width="130px">
                    <Template Context="u">
                        @u.TodayEstimatedCostUsd.ToString("C4")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="UserDailyUsageDto" Property="LastLoginAt" Title="Last Login">
                    <Template Context="u">
                        @(u.LastLoginAt?.ToString("yyyy-MM-dd HH:mm") ?? "—")
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </LoadingErrorCard>
</RadzenCard>

@code {
    private List<UserDailyUsageDto> _users = [];
    private bool _loading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _users = await Http.GetFromJsonAsync<List<UserDailyUsageDto>>("/api/admin/users")
                     ?? [];
        }
        catch (Exception ex)
        {
            _error = $"Failed to load usage data: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }
}
