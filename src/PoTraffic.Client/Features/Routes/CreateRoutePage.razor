@page "/routes/create"
@using System.Net.Http.Json
@using PoTraffic.Shared.Enums
@inject HttpClient Http
@inject NavigationManager Nav

<RadzenCard Style="max-width:560px;margin:auto;margin-top:48px;">
    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Add New Route</RadzenText>

    @if (!string.IsNullOrEmpty(_error))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" class="rz-mb-3">@_error</RadzenAlert>
    }

    <RadzenFormField Text="Origin Address" class="rz-w-100 rz-mb-2">
        <RadzenTextBox @bind-Value="_origin" />
    </RadzenFormField>
    <RadzenButton Text="Verify" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small"
                  Click="@VerifyOriginAsync" class="rz-mb-3" />

    <RadzenFormField Text="Destination Address" class="rz-w-100 rz-mb-2">
        <RadzenTextBox @bind-Value="_destination" />
    </RadzenFormField>
    <RadzenButton Text="Verify" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small"
                  Click="@VerifyDestinationAsync" class="rz-mb-3" />

    <RadzenFormField Text="Provider" class="rz-w-100 rz-mb-4">
        <RadzenDropDown @bind-Value="_provider"
                        Data="@_providers"
                        TextProperty="Label" ValueProperty="Value"
                        Style="width:100%" />
    </RadzenFormField>

    <RadzenFieldset Text="Monitoring Schedule" class="rz-mb-4">
        <div class="rz-display-flex rz-gap-4 rz-mb-3">
            <RadzenFormField Text="Start Time">
                <RadzenDatePicker @bind-Value="_startTime" ShowTime="true" TimeOnly="true" DateFormat="HH:mm" />
            </RadzenFormField>
            <RadzenFormField Text="End Time">
                <RadzenDatePicker @bind-Value="_endTime" ShowTime="true" TimeOnly="true" DateFormat="HH:mm" />
            </RadzenFormField>
        </div>

        <RadzenText TextStyle="TextStyle.Caption" class="rz-mb-2">Probe on these days:</RadzenText>
        <div class="rz-display-flex rz-gap-3 rz-flex-wrap">
            @foreach ((string label, byte bit) in _days)
            {
                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                    <input type="checkbox" checked="@IsDaySelected(bit)"
                           @onchange="@(() => ToggleDay(bit))" />
                    @label
                </label>
            }
        </div>
    </RadzenFieldset>

    <RadzenButton Text="Save Route" ButtonStyle="ButtonStyle.Primary" class="rz-w-100"
                  Click="@SaveAsync" IsBusy="_loading" />
    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" class="rz-w-100 rz-mt-2"
                  Click="@Cancel" />
</RadzenCard>

@code {
    private string _origin = string.Empty;
    private string _destination = string.Empty;
    private int _provider = 0; // GoogleMaps
    // Default start = now + 1 minute (truncated to the minute), end = start + 15 minutes
    private DateTime? _startTime = Truncate(DateTime.Now.AddMinutes(1));
    private DateTime? _endTime  = Truncate(DateTime.Now.AddMinutes(16));

    private static DateTime Truncate(DateTime dt) =>
        new(dt.Year, dt.Month, dt.Day, dt.Hour, dt.Minute, 0);
    private string _error = "";
    private bool _loading;

    private List<ProviderItem> _providers = new();
    private record ProviderItem(int Value, string Label);

    private readonly (string label, byte bit)[] _days =
    [
        ("Mon", 0x01), ("Tue", 0x02), ("Wed", 0x04),
        ("Thu", 0x08), ("Fri", 0x10), ("Sat", 0x20), ("Sun", 0x40)
    ];

    private byte _mask = 0x1F; // Monday-Friday default

    private void ToggleDay(byte bit) => _mask ^= bit;
    private bool IsDaySelected(byte bit) => (_mask & bit) != 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<ProviderItem>>("/api/routes/providers");
            if (result != null) _providers = result;
        }
        catch
        {
            // Fallback for static safety
            _providers = [new(0, "Google Maps"), new(1, "TomTom")];
        }
    }

    private async Task VerifyOriginAsync() =>
        await VerifyAddressAsync(_origin, "Origin");

    private async Task VerifyDestinationAsync() =>
        await VerifyAddressAsync(_destination, "Destination");

    private async Task VerifyAddressAsync(string address, string label)
    {
        if (string.IsNullOrWhiteSpace(address)) return;

        HttpResponseMessage resp = await Http.PostAsJsonAsync(
            "/api/routes/verify-address",
            new { address, provider = _provider });

        _error = resp.IsSuccessStatusCode
            ? $"{label} verified âœ“"
            : $"{label}: address could not be verified.";
        StateHasChanged();
    }

    private async Task SaveAsync()
    {
        _error = "";

        // Client-side guard: end must be after start
        if (_endTime <= _startTime)
        {
            _error = "End time must be after start time.";
            return;
        }

        if (_mask == 0)
        {
            _error = "Select at least one day.";
            return;
        }

        _loading = true;
        try
        {
            HttpResponseMessage resp = await Http.PostAsJsonAsync("/api/routes", new
            {
                originAddress = _origin,
                destinationAddress = _destination,
                provider = _provider,
                startTime = _startTime!.Value.ToString("HH:mm"),
                endTime = _endTime!.Value.ToString("HH:mm"),
                daysOfWeekMask = _mask
            });

            if (resp.IsSuccessStatusCode)
                Nav.NavigateTo("/routes");
            else
                _error = "Failed to create route. Please verify your addresses.";
        }
        catch
        {
            _error = "Unable to connect. Please try again.";
        }
        finally
        {
            _loading = false;
        }
    }

    private void Cancel() => Nav.NavigateTo("/routes");
}
